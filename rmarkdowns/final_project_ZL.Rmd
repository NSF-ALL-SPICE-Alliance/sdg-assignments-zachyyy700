---
output:
  html_document: default
  pdf_document: default
---
# Zach's Final Project for the United Nations Sustainable Development Goals

```{r}
library(tidyverse)
library(rnaturalearth)
library(here)
library(janitor)
library(plotly)
library(leaflet)
library(sf)
library(ggplot2)
library(ggpubr)
library(ggcorrplot)
library(randomForest) # runs random forest algorithm
library(missRanger) # imputes data through with random forest method
library(factoextra) # visualizes clusters
library(naniar)
```

Country/SDG of focus: SDG 7 - Affordable and Clean Energy

```{r}
#load in sdr data and clean
sdr_data <- read_csv(here("data/SDR-2023-Data.csv"))

sdr_data <- sdr_data %>%
  clean_names()
```

### Global Distribution Map of SDG 7

```{r}
#using setup techniques learned in advanced viz lesson
world <- ne_countries(scale = "medium", returnclass = "sf")

world <- world %>%
  select(name_long, iso_a3, geometry)

colnames(sdr_data)[which(colnames(sdr_data) == "country_code_iso3")] <- "iso_a3"

#combine dataframes
sdr_data_world_joined <- left_join(sdr_data, world, by = "iso_a3")

#convert to sf dataframe
sdr_data_world_joined <- st_as_sf(sdr_data_world_joined)

#specify crs
sdr_data_world_joined <- st_transform(sdr_data_world_joined, "+proj=longlat +datum=WGS84")

```

```{r}
#plot sdg7 map
mytext <- paste(
    "Country: ", sdr_data_world_joined$country,"<br/>", 
    "Goal 7 Score: ", round(sdr_data_world_joined$goal_7_score, 2), 
    sep="") %>%
  lapply(htmltools::HTML)

leaflet(sdr_data_world_joined) %>% 
  addTiles()  %>% 
  setView(lat=10, lng=0 , zoom=2) %>%
  addPolygons(stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, color = ~colorQuantile("PRGn", goal_7_score)(goal_7_score), label = mytext)
 
```

This is a map displaying the distribution of SDG 7 scores. High SDG 7 scores are indicated in dark green while low SDG 7 scores are indicated by dark purple. Off the bat, it seems like the map is split into two parts. The majority of the left side is green with a handful of purple outliers, this part includes Europe as well. The opposite is true for the right side of the map, including Africa.

I want to see the top and bottom 5 for this score.

```{r}
top_5 <- sdr_data[order(-sdr_data$goal_7_score), ][1:5, ]

bottom_5 <- sdr_data[order(sdr_data$goal_7_score), ][1:5, ]

ggplot(top_5, aes(y = reorder(country, goal_7_score), x = goal_7_score)) +
  geom_bar(stat = "identity") +
  labs(title = "Top 5 SDG 7 Countries",
       x = "SDG 7 Score",
       y = "Country") +
  theme_minimal()
  
ggplot(bottom_5, aes(y = reorder(country, -goal_7_score), x = goal_7_score)) +
  geom_bar(stat = "identity") +
  labs(title = "Bottom 5 SDG 7 Countries",
       x = "SDG 7 Score",
       y = "Country") +
  theme_minimal()
```

These two bar graphs display the top and bottom 5 countries for this SDG score. Four out of five countries are a part of Europe, with the exception of Uruguay with scores ranging from 93.0 to 99.6. On the other hand, all bottom five countries are located within Africa. According to the UN's SDG Report from 2023, 675 million people still lack access to electricity, 80% of those are in Sub-Saharan Africa. IÊ»d like to investigate the indicators for this SDG to see what factors influence affordable and clean energy the most. First, let's create a correlation matrix and compare with other scores.

```{r}
sdr_scores <- sdr_data %>%
  select(goal_1_score, goal_2_score, goal_3_score, goal_4_score, goal_5_score, goal_6_score, goal_7_score, goal_8_score, goal_9_score, goal_10_score, goal_11_score, goal_12_score, goal_13_score, goal_14_score, goal_15_score, goal_16_score, goal_17_score)

sdr_scores_matrix <- as.matrix(sdr_scores)

cor <- cor(sdr_scores_matrix, use = "complete.obs")

ggcorrplot(cor, method = "circle", type = "lower", lab = TRUE, lab_size = 2) +
  theme(axis.text.y = element_text(size = 8),
        axis.text.x = element_text(size = 8))
```

Let's explore this further with some regression plots. The two highest goals that correlate to SDG 7 are goal 3 (0.86) and goal 11 (0.79).

```{r}
ggplot(sdr_data, aes(x = goal_7_score, y = goal_3_score, color = regions_used_for_the_sdr)) +
  labs(title = "Goal 7 & 3 Regression",
       color = "Region") +
  geom_point() +
  geom_smooth(aes(group = 1), color = "black") +
  theme_minimal()
```

From the correlation matrix and this regression plot, goal 3 is has a strong, positive relationship with our goal of interest, goal 7. Goal 3 is defined by the UN as Good Health and Well-being. First, when analyzing the data by region, we can see that Sub-Saharan Africa occupies a large cluster on the bottom left of the chart with both low goal 7 and goal 3 scores, with a handful of outliers. Occupying the middle portion of the graph is East & South Asia shown in brown. On the other side of the chart is a tight cluster of the remaining regions with the OECD grouping the highest.This sparked a question of why would these two goals be related to each other? My initial hypothesis is regions whose population is exposed to more fossil fuel based energy sources, experience more health problems, and vice versa. Let's investigate what indicators could be causing this.

```{r}
#first let's impute our data from ML lesson
sdr_data_normalized_scores <- sdr_data %>%
  select(country, contains("normalized_score"))

sdr_data_normalized_scores_longer <- sdr_data_normalized_scores %>% 
  pivot_longer(cols = !country)

missing_data_by_country <- sdr_data_normalized_scores_longer %>%
  group_by(country) %>%
  miss_var_summary() %>%
  arrange(desc(pct_miss))

completely_na_countries  <- missing_data_by_country$country[missing_data_by_country$pct_miss == 100]

sdr_data_normalized_scores_no_na_countries <- sdr_data_normalized_scores %>% 
  filter(!country %in% completely_na_countries)

sdr_data_normalized_scores_less_na <- sdr_data_normalized_scores_no_na_countries %>%
  select(where(~ sum(is.na(.))/length(.) <= 0.2))
sdr_data_imputed <- missRanger(sdr_data_normalized_scores_less_na)

```
Here's a list of sdg7 & sdg3 indicators:
```{r}
goal7_indicators <- sdr_data_imputed %>%
  select(country, contains("normalized_score_sdg7"))
print(colnames(goal7_indicators))

cat("\n")

goal3_indicators <- sdr_data_imputed %>%
  select(country, contains("normalized_score_sdg3"))
print(colnames(goal3_indicators))
```
Focusing on sdg7_cleanfuel, let's implement randomForest
```{r}
rf_cleanfuel <- randomForest(normalized_score_sdg7_cleanfuel ~ .,
                             data = sdr_data_imputed,
                             importance = TRUE)

importance_cleanfuel_df <- as.data.frame(rf_cleanfuel$importance)
importance_cleanfuel_df_5 <- importance_cleanfuel_df %>%
  rownames_to_column(var = "variable") %>%
  slice_max(n = 5, order_by = `%IncMSE`)

ggplot(importance_cleanfuel_df_5, aes(x = `%IncMSE`, y = reorder(variable, `%IncMSE`))) +
  geom_bar(stat = "identity", fill = "#449C00", color = "black") +
  theme_minimal() +
  labs(title = "Most Important Variables in Predicting Clean Fuel",
       subtitle = "Top 5",
       y = "SDG Indicator",
       x = "Feature Importance (% Increase in Mean Squared Error)")
```
Here's the importance of the top 5 indicators, the top being sdg3_pollmort. This variable is target 3.9. According to the UN, the goal is to reduce the number of deaths/illness from hazardous chemicals and environmental pollution by 2030. This shows that the top factor that influences sdg7_cleanfuel which is a measure of access to clean cooking fuels. Going off of my initial hypothesis, this does line up and make sense. Cooking the food we consume is one of humanities' essential practices, making raw meat safer to eat so when cooking multiple times a day, we must be mindful of the fuels we use. Fuels that pollute include wood, other biomass, charcoal, and dung. Unfortunately, 2.1 billion people worldwide still lack access to clean cooking(WHO, 2022). Chronic exposure to the combustion of these fuels increase the risk of heart disease, stroke, cancers, and lung disease. Additionally, women and children in low income countries are disproportionately affected by this issue. 

I wanna make one more plot showing clusters of countries, emphasizing the difference between low income to high income countries. When trying to cluster, instead of using the imputed data from before, I'm going to use the data from earlier to only include sdg7 to try and have clusters relating to only that sdg. Not sure if this affects the integrity of the data but I'll try it anyway.

```{r}

goal7_indicators <- goal7_indicators %>%
  remove_rownames %>%
  column_to_rownames(var = "country")

fviz_nbclust(goal7_indicators, kmeans, method = "silhouette")
```

Two clusters are suggested again.

```{r}
k2 <- kmeans(goal7_indicators, centers = 2)

fviz_cluster(k2, data = goal7_indicators) +
  theme_minimal()

country_clusters <- as.data.frame(k2$cluster)

new_country_clusters <- country_clusters
new_country_clusters$Country <- rownames(country_clusters)
rownames(new_country_clusters) <- NULL
```
In this cluster map, we have two clusters formed from our data. 
